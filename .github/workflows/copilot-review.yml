name: Copilot Review Trigger

on:
  pull_request:
    types:
      - opened
      - ready_for_review
      - synchronize
    paths-ignore:
      - "**/*.md"
      - "docs/**"
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to request Copilot review for"
        required: true
        type: number
      head_sha:
        description: "Optional head SHA override (defaults to PR head SHA)"
        required: false
        type: string
      force:
        description: "Force trigger even if this SHA was already requested"
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: copilot-review-${{ github.event.pull_request.number || github.event.inputs.pr_number || github.run_id }}
  cancel-in-progress: true

jobs:
  trigger-copilot-review:
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Copilot Review
        uses: actions/github-script@v7
        with:
          script: |
            const eventName = context.eventName;
            const isManual = eventName === "workflow_dispatch";
            const force = String(context.payload.inputs?.force || "false") === "true";
            const prNumber = Number(
              context.payload.pull_request?.number || context.payload.inputs?.pr_number
            );
            if (!Number.isInteger(prNumber) || prNumber <= 0) {
              core.setFailed("Invalid pr_number input.");
              return;
            }

            const pull = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const headSha = String(
              context.payload.inputs?.head_sha || pull.data?.head?.sha || ""
            ).trim().toLowerCase();
            if (!/^[a-f0-9]{40}$/.test(headSha)) {
              core.setFailed(`Unable to determine valid head SHA for PR #${prNumber}.`);
              return;
            }

            const marker = `<!-- copilot-auto-review sha:${headSha} -->`;
            if (!force) {
              const comments = await github.paginate(
                github.rest.issues.listComments,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  per_page: 100
                }
              );
              const alreadyTriggered = comments.some((comment) =>
                String(comment?.body || "").includes(marker)
              );
              if (alreadyTriggered) {
                core.notice(`Skipping duplicate Copilot trigger for PR #${prNumber} @ ${headSha}.`);
                return;
              }
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                "/copilot review",
                "",
                isManual
                  ? (force ? "Manual forced fallback trigger." : "Manual fallback trigger.")
                  : "Automatic trigger on PR update.",
                `Head SHA: ${headSha}`,
                marker
              ].join("\n")
            });
            core.info(`Posted Copilot trigger for PR #${prNumber} @ ${headSha}.`);
