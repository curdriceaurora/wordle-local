name: Copilot Review Backstop

on:
  pull_request:
    types:
      - opened
      - reopened
      - ready_for_review
      - synchronize

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: copilot-backstop-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  ensure-copilot-review:
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    steps:
      - name: Wait for native Copilot auto-review
        run: sleep 300

      - name: Trigger Copilot review only if missing
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request?.number;
            const copilotLogin = "copilot-pull-request-reviewer";
            if (!prNumber) {
              core.setFailed("Missing pull request number in event payload.");
              return;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber
            });

            if (pr.draft) {
              core.info("PR is draft at backstop check time; skipping.");
              return;
            }

            const headSha = pr.head.sha;
            const marker = `<!-- copilot-auto-trigger:${headSha} -->`;

            const { data: reviews } = await github.rest.pulls.listReviews({
              owner,
              repo,
              pull_number: prNumber,
              per_page: 100
            });

            const hasReviewOnHead = reviews.some(
              (review) =>
                review?.user?.login === copilotLogin &&
                review?.commit_id === headSha
            );
            if (hasReviewOnHead) {
              core.info(`Copilot already reviewed head SHA ${headSha}.`);
              return;
            }

            const hasRequestedReviewer = Array.isArray(pr.requested_reviewers)
              ? pr.requested_reviewers.some(
                  (reviewer) => reviewer?.login === copilotLogin
                )
              : false;
            if (hasRequestedReviewer) {
              core.info("Copilot review request already pending; skipping backstop trigger.");
              return;
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100
            });
            const hasMarker = comments.some(
              (comment) =>
                ["github-actions", "github-actions[bot]"].includes(
                  String(comment?.user?.login || "")
                ) &&
                typeof comment?.body === "string" &&
                comment.body.includes(marker)
            );
            if (hasMarker) {
              core.info(`Backstop already triggered for head SHA ${headSha}.`);
              return;
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: `/copilot review\n\nBackstop auto-trigger for head SHA \`${headSha.slice(0, 12)}\`.\n${marker}`
            });
            core.info(`Triggered /copilot review for PR #${prNumber} on ${headSha}.`);
